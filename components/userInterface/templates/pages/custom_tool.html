{% load static %}
{% load widget_tweaks %}

{% block breadcrumbs %}{% endblock breadcrumbs %}

{% block content %}
<div class="card px-0 py-3" style="border-radius: 15px;">
    <form method="POST">
        {% csrf_token %}
        <div>
            <button name="deleteCustom{{name}}" type="submit" class="btn btn-danger ml-2">Delete tool</button>
            <a href="{% url 'edit_tool' tool_name=name %}">
                <button type="button" class="btn btn-primary">Edit tool</button>
            </a>
        </div>
    </form>

    <h2 class="text-center mb-5" style="text-decoration: underline;">
        <button type="button" class="btn btn-primary btn-xl" disabled>{{ machine_chosen }}</button>
    </h2>
    <form method="post">
        {% csrf_token %}
        {% for section in sections %}
            <div class="card-header clickable-header" style="cursor: pointer; display: flex; align-items: center; justify-content: space-between;">
                <h5 class="mb-0">{{ section|capfirst }}</h5>
                <span class="toggle-icon">▼</span>
            </div>
            <div class="card-block px-0 py-3">
                <div class="section-content" id="section-{{ section }}" style="display: block;">
                    {% for modified_name, field in fields.items %}
                        {% if field.section == section %}
                            {% for f in form %}
                                {% if modified_name == f.label %}
                                    <div class="form-group">
                                        <label for="{{ f.id_for_label }}">{{ f.label }}:</label>
                                        {{ f|add_class:"form-control" }}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
        <form method="POST">
            {% csrf_token %}
            <input type="hidden" value="{{ e.eID }}" name="{{name}}ButtonValue">
            <button type="submit" name="{{name}}Button" class="btn btn-success btn-block btn-lg gradient-custom-4 feather icon-play" data-toggle="tooltip" data-placement="top" title="Run execution"></button>
        </form>
    </form>
</div>

<script>
let fieldCounter = {{ existing_fields|length }};
let repoCounter = {{ existing_repos|length }};

document.addEventListener('DOMContentLoaded', function() {
    var sectionHeaders = document.querySelectorAll('.card-header h5');
    sectionHeaders.forEach(function(header) {
        header.addEventListener('click', function() {
            var sectionContent = this.closest('.card-header').nextElementSibling.querySelector('.section-content');
            if (sectionContent) {
                sectionContent.style.display = sectionContent.style.display === 'none' ? 'block' : 'none';
            }
        });
    });
});

document.addEventListener('DOMContentLoaded', function() {
    var sectionHeaders = document.querySelectorAll('.clickable-header');
    sectionHeaders.forEach(function(header) {
        header.addEventListener('click', function() {
            var sectionContent = this.nextElementSibling.querySelector('.section-content');
            if (sectionContent) {
                sectionContent.style.display = sectionContent.style.display === 'none' ? 'block' : 'none';
                var icon = this.querySelector('.toggle-icon');
                if (icon) {
                    icon.textContent = sectionContent.style.display === 'none' ? '▼' : '▲';
                }
            }
        });
    });
});

document.getElementById('add-repo').onclick = function() {
    repoCounter++;
    const setupSection = document.getElementById('setup-section');
    const newRepoDiv = document.createElement('div');
    newRepoDiv.classList.add('form-group');
    newRepoDiv.innerHTML = `
        <label for="github_repo_${repoCounter}">GitHub Repo ${repoCounter}:</label>
        <div class="d-flex align-items-center">
            <input type="text" name="github_repo_${repoCounter}" class="form-control flex-grow-1" id="github_repo_${repoCounter}">
            <input type="hidden" name="section_github_repo_${repoCounter}" value="setup">
            <button type="button" class="btn btn-danger ml-2" onclick="removeField(this)">-</button>
        </div>
    `;
    setupSection.appendChild(newRepoDiv);
};

document.querySelectorAll('.add-field').forEach(button => {
    button.addEventListener('click', () => {
        fieldCounter++;
        const section = button.getAttribute('data-section');
        const sectionContent = document.getElementById('section-' + section);
        const newFieldDiv = document.createElement('div');
        newFieldDiv.classList.add('form-group');
        newFieldDiv.innerHTML = `
            <label for="custom_field_${fieldCounter}">Custom Field ${fieldCounter}:</label>
            <div class="d-flex">
                <input type="text" name="custom_field_${fieldCounter}" class="form-control flex-grow-1" id="custom_field_${fieldCounter}">
                <input type="text" name="default_value_${fieldCounter}" class="form-control ml-2" id="default_value_${fieldCounter}" placeholder="Default Value (optional)">
                <input type="text" name="preset_value_${fieldCounter}" class="form-control ml-2" id="preset_value_${fieldCounter}" placeholder="Preset Value (optional)">
                <input type="hidden" name="section_${fieldCounter}" value="${section}">
                <button type="button" class="btn btn-danger ml-2" onclick="removeField(this)">-</button>
            </div>
        `;
        sectionContent.appendChild(newFieldDiv);

        document.getElementById(`default_value_${fieldCounter}`).addEventListener('input', function() {
            toggleFieldState(`preset_value_${fieldCounter}`, this);
        });

        document.getElementById(`preset_value_${fieldCounter}`).addEventListener('input', function() {
            toggleFieldState(`default_value_${fieldCounter}`, this);
        });
    });
});

function toggleFieldState(fieldToToggle, currentField) {
    const field = document.getElementById(fieldToToggle);
    field.disabled = currentField.value.length > 0;
}

function removeField(element) {
    element.parentElement.parentElement.remove();
}
</script>
<style>
.clickable-header:hover {
    background-color: #f8f9fa;
}
.toggle-icon {
    font-size: 14px;
    margin-left: 10px;
    transition: transform 0.2s;
}
</style>
{% endblock content %}
